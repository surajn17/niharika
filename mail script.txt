#!/bin/bash

servers_ips="servers_file"

# Output file for successful connections
success_log="successful_connections"

# Output file for failed connections
error_log="failed_connections"

readarray -t servers < "$servers_ips"

# Iterate through the server list and check SSH connection
for server in "${servers[@]}"; do
  if ssh -i key ubuntu@"$server" exit; then
    echo "$(date): Successfully connected to $server" >> "$success_log"

    # Add commands to collect logs info from the server.
    logs_info=$(ssh -i key ubuntu@"$server" "cat /var/log/alternatives.log")
    echo "$logs_info" > "logs_info_$server.log"
    echo "$logs_info" | mailx -s "Logs Info from $server" niharika.kadellabs@gmail.com
  else
    echo "$(date): Error: $server not found or connection failed" >> "$error_log"
    echo "Connection to $server failed." | mailx -s "Failed Connection to $server" niharika.kadellabs@gmail.com
  fi
done

echo "task complete"
